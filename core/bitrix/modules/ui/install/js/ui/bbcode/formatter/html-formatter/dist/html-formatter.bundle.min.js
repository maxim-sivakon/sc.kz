this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};this.BX.UI.BBCode=this.BX.UI.BBCode||{};(function(e,t,r,n,o,a,s){"use strict";function i(e,t=1){const r=[];for(let n=0;n<t;n++){r.push(e.createElement({name:"p"}))}return r}function c(e){return e.getType()!==n.BBCodeNode.ELEMENT_NODE||e.hasGroup("#inline")||e.hasGroup("#inlineBlock")}function l(e,t){const r=[];let n=null;let o=0;for(const a of e){if(t.isNewLine(a)){o++;continue}if(c(a)){if(n===null||o>=2){r.push(...i(t,o-2));n=t.createElement({name:"p"});r.push(n)}else if(o===1){n.appendChild(t.createNewLine())}n.appendChild(a)}else{if(o>2){r.push(...i(t,o-2))}r.push(a);n=null}o=0}if(r.length===0){return[t.createElement({name:"p"})]}return r}function u(e){const t=e.getScheme();const r=l(e.getChildren(),t);e.setChildren(r);return e}class d extends s.NodeFormatter{constructor(e={}){super({name:"#root",convert(){return document.createDocumentFragment()},before({node:e}){return u(e)},...e})}}function m(e,t){let r=e;while(r!==null&&r.getType()!==n.BBCodeNode.ROOT_NODE){if(t(r)){return r}r=r.getParent()}return null}var g=babelHelpers.classPrivateFieldLooseKey("smileyParser");class p extends s.NodeFormatter{constructor(e={}){super({name:"#text",convert({node:e}){const r=e.toString();if(m(e,(e=>e.getName()==="code"))){return document.createTextNode(r)}const n=babelHelpers.classPrivateFieldLooseBase(this,g)[g].parse(r);if(n.length===0){return document.createTextNode(r)}const o=document.createDocumentFragment();let a=0;for(const e of n){if(a<e.start){const t=document.createTextNode(r.slice(a,e.start));o.appendChild(t)}const n=r.slice(e.start,e.end);const s=t.SmileyManager.get(n);if(s===null){o.appendChild(document.createTextNode(n))}else{o.appendChild(this.createImg(s))}a=e.end}if(a<r.length){const e=document.createTextNode(r.slice(a));o.appendChild(e)}return o},...e});Object.defineProperty(this,g,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,g)[g]=new t.SmileyParser(t.SmileyManager.getAll())}createImg(e){const t=document.createElement("img");t.src=encodeURI(e.getImage());t.className="ui-typography-smiley";t.alt=e.getTyping();if(e.getWidth()>0&&e.getHeight()>0){t.width=e.getWidth();t.height=e.getHeight()}return t}}class h extends s.NodeFormatter{constructor(e={}){super({name:"#tab",convert({node:e}){if(e.getParent().getName()==="code"){return document.createTextNode(e.toString())}return document.createTextNode(" ")},...e})}}class N extends s.NodeFormatter{constructor(e={}){super({name:"#linebreak",convert({node:e}){return document.createElement("br")},...e})}}function f(e){const t=[...e];const r=t[0];const n=t[t.length-1];if(y(r)||b(r)&&r.isEmpty()){t.splice(0,1)}if(y(n)||b(n)&&n.isEmpty()){t.splice(-1,1)}return t}function y(e){return e&&e.getScheme().isNewLine(e)}function b(e){return e&&e.getName()==="p"}function F(e){const t=e.getScheme();const r=f(e.getChildren(),t);e.setChildren(r);if(r.length===0||!t.isNewLine(r.at(-1))&&/^\s*$/.test(e.getTextContent())){e.appendChild(t.createNewLine())}return e}class v extends s.NodeFormatter{constructor(e={}){super({name:"p",convert({node:e}){return a.Dom.create({tag:e.getName(),attrs:{className:"ui-typography-paragraph"}})},before({node:e}){return F(e)},...e})}}class T extends s.NodeFormatter{constructor(e={}){super({name:"b",convert({node:e}){return a.Dom.create({tag:"b",attrs:{...e.getAttributes(),className:"ui-typography-text-bold"}})},...e})}}class x extends s.NodeFormatter{constructor(e={}){super({name:"u",convert({node:e}){return a.Dom.create({tag:"u",attrs:{...e.getAttributes(),className:"ui-typography-text-underline"}})},...e})}}class A extends s.NodeFormatter{constructor(e={}){super({name:"i",convert({node:e}){return a.Dom.create({tag:"i",attrs:{...e.getAttributes(),className:"ui-typography-text-italic"}})},...e})}}class S extends s.NodeFormatter{constructor(e={}){super({name:"s",convert({node:e}){return a.Dom.create({tag:"s",attrs:{...e.getAttributes(),className:"ui-typography-text-strikethrough"}})},...e})}}class L extends s.NodeFormatter{constructor(e={}){super({name:"span",convert({node:e}){return a.Dom.create({tag:"span",attrs:e.getAttributes()})},...e})}}class B extends s.NodeFormatter{constructor(e={}){super({name:"table",convert(){return a.Dom.create({tag:"table",attrs:{classname:"ui-typography-table"}})},...e})}}class C extends s.NodeFormatter{constructor(e={}){super({name:"th",convert(){return a.Dom.create({tag:"th",attrs:{classname:"ui-typography-table-cell ui-typography-table-cell-header"}})},before({node:e}){return u(e)},...e})}}class D extends s.NodeFormatter{constructor(e={}){super({name:"td",convert(){return a.Dom.create({tag:"td",attrs:{classname:"ui-typography-table-cell"}})},before({node:e}){return u(e)},...e})}}class w extends s.NodeFormatter{constructor(e={}){super({name:"tr",convert(){return a.Dom.create({tag:"tr",attrs:{classname:"ui-typography-table-row"}})},...e})}}class P extends s.NodeFormatter{constructor(e){super({name:"list",convert({node:e}){const t=e.getValue()==="1"?"ol":"ul";return a.Dom.create({tag:t,attrs:{...e.getAttributes(),className:`ui-typography-${t}`}})},...e})}}class E extends s.NodeFormatter{constructor(e){super({name:"*",convert({node:e}){return a.Dom.create({tag:"li",attrs:{...e.getAttributes(),className:"ui-typography-li"}})},...e})}}class I extends s.NodeFormatter{constructor(e={}){super({name:"quote",convert(){return a.Dom.create({tag:"blockquote",attrs:{className:"ui-typography-quote"}})},before({node:e}){return F(e)},...e})}}var k=babelHelpers.classPrivateFieldLooseKey("codeParser");class M extends s.NodeFormatter{constructor(e={}){super({name:"code",before({node:e}){return F(e)},convert({node:e}){const t=e.getTextContent();return a.Dom.create({tag:"code",attrs:{className:"ui-typography-code"},dataset:{decorator:true},children:H(babelHelpers.classPrivateFieldLooseBase(this,k)[k].parse(t))})},...e});Object.defineProperty(this,k,{writable:true,value:new r.CodeParser})}}function H(e){const t=[];e.forEach((e=>{const r=e.content.split(/([\t\n])/);const n=r.length;for(let o=0;o<n;o++){const n=r[o];if(n==="\n"||n==="\r\n"){t.push(document.createElement("br"))}else if(n==="\t"){t.push(document.createTextNode("\t"))}else if(n.length>0){const r=document.createElement("span");r.className=`ui-typography-token-${e.type}`;r.textContent=n;t.push(r)}}}));return t}class O extends s.NodeFormatter{constructor(e={}){super({name:"url",validate({node:e}){const t=O.fetchNodeValue(e);return!O.startsWithJavascriptScheme(t)},before({node:e,formatter:t}){if(t.isShortLinkEnabled()){const r=e.getChildren().some((e=>e.getName()==="img"));if(!r){const r=e.getScheme();const n=e.getPlainTextLength();const{shortLink:o}=t.getLinkSettings();if(n>o.maxLength){const t=O.fetchNodeValue(e);const n=r.createRoot({children:e.getChildren()});const[a,s]=n.split({offset:o.maxLength-o.lastFragmentLength});const i=s.getPlainTextLength();const c=e.clone();c.setValue(t);if(i>o.lastFragmentLength){c.appendChild(...a.getChildren(),r.createText("..."));const[,e]=s.split({offset:i-o.lastFragmentLength});c.appendChild(...e.getChildren());return c}c.setChildren([...a.getChildren(),r.createText("..."),...s.getChildren()]);return c}}}return e},convert({node:e,formatter:t}){const r=(()=>{const t=e.getValue();if(a.Type.isStringFilled(t)){return t}return e.getContent()})();const n=e.getAttributes();const{defaultTarget:o="_blank",attributes:s}=t.getLinkSettings();return a.Dom.create({tag:"a",attrs:{...n,...s,href:r,target:o,className:"ui-typography-link"}})},...e})}static fetchNodeValue(e){const t=e.getValue();if(a.Type.isStringFilled(t)){return t}return e.toPlainText()}static startsWithJavascriptScheme(e){if(a.Type.isStringFilled(e)){const t=/^[\u0000-\u001F ]*j[\t\n\r]*a[\t\n\r]*v[\t\n\r]*a[\t\n\r]*s[\t\n\r]*c[\t\n\r]*r[\t\n\r]*i[\t\n\r]*p[\t\n\r]*t[\t\n\r]*:/i;return t.test(e)}return false}}class U extends s.NodeFormatter{constructor(e={}){super({name:"spoiler",convert({node:e}){const t=e.getValue().trim();const r=a.Type.isStringFilled(t)?t:a.Loc.getMessage("HTML_FORMATTER_SPOILER_TITLE");return a.Dom.create({tag:"details",attrs:{className:"ui-typography-spoiler ui-icon-set__scope"},children:[a.Dom.create({tag:"summary",attrs:{className:"ui-typography-spoiler-title"},text:r})]})},before({node:e}){return u(e)},after({element:e}){const[t,...r]=e.children;e.appendChild(t);e.appendChild(a.Dom.create({tag:"div",attrs:{className:"ui-typography-spoiler-content"},children:[...r]}));return e},...e})}}class V extends s.NodeFormatter{constructor(e){super({name:"user",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(a.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.user)){const t=n.urlTemplate.user;const r=t.replaceAll("#ID#",e.getValue());return a.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"}})}return a.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"}})},...e})}}class j extends s.NodeFormatter{constructor(e={}){super({name:"department",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(a.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.department)){const t=n.urlTemplate.department;const r=t.replaceAll("#ID#",e.getValue());return a.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"}})}return a.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"}})},...e})}}class _ extends s.NodeFormatter{constructor(e={}){super({name:"project",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(a.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.project)){const t=n.urlTemplate.project;const r=t.replaceAll("#group_id#",e.getValue());return a.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"}})}return a.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"}})},...e})}}function R({src:e,width:t,height:r}){return a.Dom.create({tag:"span",attrs:{className:"ui-typography-image-container"},dataset:{decorator:true},children:[a.Dom.create({tag:"img",attrs:{src:e,className:"ui-typography-image",width:t,loading:"lazy"},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"},events:{error:e=>{const t=e.target;t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";t.style.cssText="border: 1px dashed red"}}})]})}function X(e){return/^(http:|https:|ftp:|\/)/i.test(e)}class $ extends s.NodeFormatter{constructor(e={}){super({name:"img",convert({node:e}){const t=e.getContent().trim();let r=Number(e.getAttribute("width"));let n=Number(e.getAttribute("height"));r=a.Type.isNumber(r)&&r>0?Math.round(r):null;n=a.Type.isNumber(n)&&n>0?Math.round(n):null;if(X(t)){return R({src:t,width:r,height:n})}return document.createTextNode(e.toString())},...e})}}function K({url:e,width:t,height:r,type:n}){const o=a.Dom.create({tag:"video",attrs:{controls:true,className:"ui-typography-video-object",preload:"metadata",playsinline:true,src:e,width:t},dataset:{decorator:true},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"}});return a.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[o]})}const z=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g;const W=/^(?:(?:https?|ftps?|mailto):|[^a-z]|[+.a-z-]+(?:[^+.:a-z-]|$))/i;function G(e){if(!a.Type.isStringFilled(e)){return""}const t=e.replaceAll(z,"");return W.test(t)?t:""}function q(e){return/^(http:|https:|\/)/i.test(e)}class J extends s.NodeFormatter{constructor(e={}){super({name:"video",convert({node:e}){const t=G(e.getContent().trim());if(!q(t)){return document.createTextNode(e.toString())}let r=Number(e.getAttribute("width"));let n=Number(e.getAttribute("height"));r=a.Type.isNumber(r)&&r>0?Math.round(r):560;n=a.Type.isNumber(n)&&n>0?Math.round(n):315;const s=/^https?:/.test(t)?t:`https://${t.replace(/^\/\//,"")}`;const i=new a.Uri(s);const c=o.VideoService.createByHost(i.getHost())!==null;if(c){const e=a.Dom.create({tag:"iframe",attrs:{src:t,className:"ui-typography-video-object",width:r,height:"auto",frameborder:0,allowfullscreen:true},style:{aspectRatio:`${r} / ${n}`}});return a.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[e]})}return K({url:s,width:r,height:n})},...e})}}class Q extends s.NodeFormatter{constructor(e={}){const t=e.formatter;const r=t.getFileMode();super({name:r||"__unknown__",convert({node:e,data:t}){if(r===null){return e}const n=e.getAttribute("id");const o=()=>document.createTextNode(e.toString());if(!a.Type.isStringFilled(n)||r==="disk"&&!/^n?\d+$/i.test(n)||r==="file"&&!/^(\d+|[\da-f-]{36}\.[\da-f]{32,})$/i.test(n)){return o()}const s=t.files.find((e=>e.serverFileId.toString()===n.toString()));if(!s){return o()}if(s.isImage){let t=a.Text.toInteger(e.getAttribute("width"));let r=a.Text.toInteger(e.getAttribute("height"));t=a.Type.isNumber(t)&&t>0?Math.round(t):s.serverPreviewWidth;r=a.Type.isNumber(r)&&r>0?Math.round(r):s.serverPreviewHeight;return R({width:t,height:r,src:s.serverPreviewUrl})}if(s.isVideo){let t=Number(e.getAttribute("width"));let r=Number(e.getAttribute("height"));t=a.Type.isNumber(t)&&t>0?Math.round(t):600;r=a.Type.isNumber(r)&&r>0?Math.round(r):null;return K({url:s.downloadUrl,width:t,height:r})}return a.Dom.create({tag:"a",attrs:{href:s.downloadUrl,className:"ui-typography-link"},text:s.name||"unknown",dataset:{fileId:s.serverFileId,fileInfo:JSON.stringify(s)}})},...e})}}var Y=Object.freeze({RootNodeFormatter:d,TextNodeFormatter:p,TabNodeFormatter:h,LinebreakNodeFormatter:N,ParagraphNodeFormatter:v,BoldNodeFormatter:T,UnderlineNodeFormatter:x,ItalicNodeFormatter:A,StrikethroughNodeFormatter:S,SpanNodeFormatter:L,TableNodeFormatter:B,TableHeadCellNodeFormatter:C,TableDataCellNodeFormatter:D,TableRowNodeFormatter:w,ListNodeFormatter:P,ListItemNodeFormatter:E,QuoteNodeFormatter:I,CodeNodeFormatter:M,LinkNodeFormatter:O,SpoilerNodeFormatter:U,UserNodeFormatter:V,DepartmentNodeFormatter:j,ProjectNodeFormatter:_,ImageNodeFormatter:$,VideoNodeFormatter:J,FileNodeFormatter:Q});const Z=a.Extension.getSettings("ui.bbcode.formatter.html-formatter");var ee=babelHelpers.classPrivateFieldLooseKey("linkSettings");var te=babelHelpers.classPrivateFieldLooseKey("mentionSettings");var re=babelHelpers.classPrivateFieldLooseKey("fileMode");var ne=babelHelpers.classPrivateFieldLooseKey("isVoidElement");class oe extends s.Formatter{constructor(e={}){super();Object.defineProperty(this,ne,{value:ae});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,te,{writable:true,value:void 0});Object.defineProperty(this,re,{writable:true,value:void 0});this.setLinkSettings({...Z.linkSettings,...e.linkSettings});this.setMentionSettings({...Z.mention,...e.mention});babelHelpers.classPrivateFieldLooseBase(this,re)[re]=["file","disk"].includes(e.fileMode)?e.fileMode:null;const t=Object.values(Y).map((e=>new e({formatter:this})));this.setNodeFormatters(t);this.setNodeFormatters(e.formatters)}isShortLinkEnabled(){const{shortLink:e}=this.getLinkSettings();return a.Type.isPlainObject(e)&&e.enabled===true&&a.Type.isInteger(e.maxLength)}setLinkSettings(e){babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]={...e}}getLinkSettings(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]}getFileMode(){return babelHelpers.classPrivateFieldLooseBase(this,re)[re]}setMentionSettings(e){babelHelpers.classPrivateFieldLooseBase(this,te)[te]={...e}}getMentionSettings(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te]}isElement(e){if(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE){return true}if(e.nodeType!==Node.ELEMENT_NODE||babelHelpers.classPrivateFieldLooseBase(this,ne)[ne](e)){return false}return a.Type.isUndefined(e.dataset.decorator)}getDefaultUnknownNodeCallback(e){return()=>new s.NodeFormatter({name:"unknown",before({node:e}){const t=e.getScheme();if(e.isVoid()){return t.createFragment({children:[t.createText(e.getOpeningTag())]})}return t.createFragment({children:[t.createText(e.getOpeningTag()),...e.getChildren(),t.createText(e.getClosingTag())]})},convert(){return document.createDocumentFragment()}})}}function ae(e){return["img","br","hr","input"].includes(e.tagName.toLowerCase())}e.HtmlFormatter=oe})(this.BX.UI.BBCode.Formatter=this.BX.UI.BBCode.Formatter||{},BX.UI.Smiley,BX.UI.CodeParser,BX.UI.BBCode,BX.UI.VideoService,BX,BX.UI.BBCode);
//# sourceMappingURL=html-formatter.bundle.map.js